<!-- Language: jinja2 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthPredict Pro | {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
    <style>
        /* Doctor card styles */
        .doctor-card {
            transition: transform 0.2s;
        }
        
        .doctor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .doctor-distance {
            color: #dc3545;
            font-weight: bold;
        }

        /* Advice modal styles */
        .advice-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }
        
        .advice-content {
            background-color: white;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .advice-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 1.5rem;
        }

        /* ========== CHATBOT POPUP STYLES ========== */
        .chatbot-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 1000;
            transition: all 0.3s;
            animation: float 3s ease-in-out infinite;
        }
        
        .chatbot-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .chatbot-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            animation: messageFadeIn 0.3s ease-out;
        }
        
        @keyframes messageFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }
        
        .bot-message {
            background-color: white;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .bot-message strong {
            color: #667eea;
        }
        
        .bot-message ul, .bot-message ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .bot-message li {
            margin-bottom: 5px;
        }
        
        .chatbot-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background-color: white;
            gap: 10px;
        }
        
        .chatbot-input {
            flex-grow: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 20px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chatbot-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .chatbot-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        
        .chatbot-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        .chatbot-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* File upload styles */
        .file-upload-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .file-upload-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            color: #667eea;
        }
        
        .file-preview {
            background: #e9ecef;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Chatbot scrollbar */
        .chatbot-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chatbot-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .chatbot-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chatbot-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 90%;
                right: 5%;
                height: 70vh;
                bottom: 80px;
            }
            
            .chatbot-icon {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-heartbeat me-2"></i>
                <span class="fw-bold">HealthPredict Pro</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/diabetes"><i class="fas fa-vial me-1"></i> Diabetes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/heart"><i class="fas fa-heart me-1"></i> Heart</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/kidney"><i class="fas fa-kidneys me-1"></i> Kidney</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about"><i class="fas fa-info-circle me-1"></i> About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-5 pt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show mt-3 animate__animated animate__fadeIn">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- Health Advice Modal -->
    {% if show_result and health_advice %}
    <div class="advice-modal" id="adviceModal">
        <div class="advice-content position-relative">
            <span class="advice-close" onclick="document.getElementById('adviceModal').style.display='none'">&times;</span>
            <h4 class="mb-4">Health Advice</h4>
            
            <div class="alert alert-{{ 'danger' if 'predicted to have' in result else 'success' }}">
                <strong>{{ result }}</strong> ({{ confidence }}% confidence)
            </div>
            
            <h5 class="mt-4">Recommendations:</h5>
            <ul class="list-group mb-4">
                {% for tip in health_advice.general_tips %}
                <li class="list-group-item">{{ tip }}</li>
                {% endfor %}
            </ul>
            
            {% if health_advice.doctor_visit %}
            <div class="alert alert-info">
                <i class="fas fa-user-md me-2"></i> <strong>{{ health_advice.doctor_visit }}</strong>
            </div>
            {% endif %}
            
            <h5>Additional Resources:</h5>
            <ul class="list-group">
                {% for resource in health_advice.resources %}
                <li class="list-group-item"><a href="{{ resource if 'http' in resource else '#' }}" target="_blank">{{ resource }}</a></li>
                {% endfor %}
            </ul>
            
            <div class="mt-4">
                <button class="btn btn-primary me-2" onclick="findNearbyDoctors('{{ disease_type }}')">
                    <i class="fas fa-map-marker-alt me-1"></i> Find Nearby Doctors
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('adviceModal').style.display='none'">
                    Close
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Chatbot Icon -->
    <div class="chatbot-icon" onclick="toggleChatbot()">
        <i class="fas fa-robot fa-lg"></i>
    </div>

    <!-- Chatbot Popup Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div>
                <i class="fas fa-robot me-2"></i>
                <span>Health AI Assistant</span>
                <small class="d-block" style="font-size: 0.8rem; opacity: 0.9;">Powered by Gemini AI</small>
            </div>
            <div>
                <button class="btn btn-sm btn-light me-2" onclick="clearChat()" title="Clear chat">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <span onclick="toggleChatbot()" style="cursor: pointer; font-size: 1.2rem;">
                    <i class="fas fa-times"></i>
                </span>
            </div>
        </div>
        
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message bot-message">
                üëã <strong>Hello! I'm your Health AI Assistant.</strong><br><br>
                I can help you with:
                ‚Ä¢ Health questions and symptoms
                ‚Ä¢ Medical information and advice
                ‚Ä¢ Wellness and lifestyle tips
                ‚Ä¢ Medicine and treatment info
                <br><br>
                <small><em>Note: I provide information only, not medical diagnoses.</em></small>
            </div>
        </div>
        
        <div class="file-upload-container" style="padding: 0 15px; display: none;" id="fileUploadContainer">
            <div class="file-preview" id="filePreview">
                <div class="file-preview-item" id="filePreviewItem">
                    <i class="fas fa-file" id="fileIcon"></i>
                    <div style="flex: 1;">
                        <strong id="fileName"></strong>
                        <div class="small text-muted" id="fileSize"></div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearFile()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chatbot-input-container">
            <input type="text" 
                   class="chatbot-input" 
                   id="userMessage" 
                   placeholder="Ask a health question..."
                   onkeypress="handleKeyPress(event)"
                   autocomplete="off">
            
            <div style="display: flex; gap: 5px;">
                <button class="file-upload-btn" onclick="openFileUpload()" title="Upload file">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.pdf" style="display: none;" onchange="handleFileSelect(event)">
                
                <button class="chatbot-send-btn" onclick="sendMessage()" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="fw-bold mb-3">HealthPredict Pro</h5>
                    <p>Advanced disease prediction using machine learning to help you understand your health risks.</p>
                </div>
                <div class="col-md-4">
                    <h5 class="fw-bold mb-3">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="/diabetes" class="text-white">Diabetes Prediction</a></li>
                        <li><a href="/heart" class="text-white">Heart Disease Prediction</a></li>
                        <li><a href="/kidney" class="text-white">Kidney Disease Prediction</a></li>
                        <li><a href="/about" class="text-white">About Us</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="fw-bold mb-3">Contact</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> contact@healthpredictpro.com</li>
                        <li><i class="fas fa-phone me-2"></i> +1 (555) 123-4567</li>
                        <li class="mt-3">
                            <a href="#" class="text-white me-2"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-white me-2"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-white me-2"><i class="fab fa-linkedin-in"></i></a>
                            <a href="#" class="text-white"><i class="fab fa-instagram"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 bg-light">
            <div class="text-center">
                <p class="mb-0">&copy; 2025 HealthPredict Pro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <script>
        // ========== CHATBOT POPUP FUNCTIONS ==========
        let chatbotOpen = false;
        let currentFile = null;
        let isProcessing = false;
        let chatHistory = [];

        // Toggle chatbot popup
        function toggleChatbot() {
            const chatbot = document.getElementById('chatbotContainer');
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                chatbot.style.display = 'flex';
                document.getElementById('userMessage').focus();
                
                // Load chat history
                loadChatHistory();
            } else {
                chatbot.style.display = 'none';
            }
        }

        // Load chat history from localStorage
        function loadChatHistory() {
            const savedChat = localStorage.getItem('healthPopupChatHistory');
            if (savedChat) {
                try {
                    chatHistory = JSON.parse(savedChat);
                    if (chatHistory.length > 0) {
                        const messagesContainer = document.getElementById('chatbotMessages');
                        // Keep only the initial welcome message
                        messagesContainer.innerHTML = '<div class="message bot-message">üëã <strong>Hello! I\'m your Health AI Assistant.</strong><br><br>I can help you with health questions, medical information, and wellness advice.</div>';
                        
                        // Add chat history
                        chatHistory.forEach(item => {
                            addMessageToChat(item.userMessage, 'user');
                            addMessageToChat(item.botResponse, 'bot');
                        });
                        
                        scrollToBottom();
                    }
                } catch (e) {
                    console.error('Error loading chat history:', e);
                }
            }
        }

        // Save message to history
        function saveToHistory(userMessage, botResponse, type) {
            chatHistory.push({
                userMessage,
                botResponse,
                type,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 20 messages
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(-20);
            }
            
            // Save to localStorage
            localStorage.setItem('healthPopupChatHistory', JSON.stringify(chatHistory));
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear all chat messages?')) {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.innerHTML = '<div class="message bot-message">üëã <strong>Hello! I\'m your Health AI Assistant.</strong><br><br>I can help you with health questions, medical information, and wellness advice.</div>';
                chatHistory = [];
                localStorage.removeItem('healthPopupChatHistory');
                scrollToBottom();
            }
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Open file upload
        function openFileUpload() {
            document.getElementById('fileInput').click();
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file
            if (!file.type.match('image.*') && file.type !== 'application/pdf') {
                alert('Please upload only images (JPG, PNG) or PDF files.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File size must be less than 10MB.');
                return;
            }
            
            currentFile = file;
            
            // Show file preview
            const preview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileIcon = document.getElementById('fileIcon');
            const uploadContainer = document.getElementById('fileUploadContainer');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileIcon.className = file.type === 'application/pdf' 
                ? 'fas fa-file-pdf text-danger' 
                : 'fas fa-file-image text-success';
            
            preview.style.display = 'block';
            uploadContainer.style.display = 'block';
            
            // Scroll to show file preview
            setTimeout(() => {
                document.getElementById('fileUploadContainer').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Clear file
        function clearFile() {
            currentFile = null;
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileUploadContainer').style.display = 'none';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Add message to chat
        function addMessageToChat(content, sender) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}-message`;
            
            // Format message content
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = formattedContent;
            messagesContainer.appendChild(messageDiv);
            
            scrollToBottom();
        }

        // Show typing indicator
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const typingDiv = document.createElement('div');
            
            typingDiv.className = 'message bot-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<div class="typing-indicator"><span>AI is thinking</span><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
            
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatbotMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message to chatbot
        async function sendMessage() {
            const userInput = document.getElementById('userMessage');
            const message = userInput.value.trim();
            const sendBtn = document.getElementById('sendBtn');
            
            if ((!message && !currentFile) || isProcessing) {
                return;
            }
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Clear input and file
            userInput.value = '';
            clearFile();
            
            // Disable send button and show typing indicator
            sendBtn.disabled = true;
            isProcessing = true;
            showTypingIndicator();
            
            try {
                // Prepare form data
                const formData = new FormData();
                if (message) formData.append('message', message);
                if (currentFile) formData.append('file', currentFile);
                
                console.log('Sending message to chatbot...');
                
                // Send request to backend
                const response = await fetch('/chatbot', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Bot response received:', data.type);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.type === 'error') {
                    addMessageToChat('‚ùå ' + data.response, 'bot');
                } else {
                    addMessageToChat(data.response, 'bot');
                }
                
                // Save to chat history
                saveToHistory(message, data.response, currentFile ? 'file' : 'text');
                
            } catch (error) {
                console.error('Error sending message:', error);
                removeTypingIndicator();
                addMessageToChat('‚ö†Ô∏è Sorry, I encountered an error. Please try again.', 'bot');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                isProcessing = false;
                userInput.focus();
            }
        }

        // ========== DOCTOR FINDER FUNCTIONS ==========
        function findNearbyDoctors(specialty) {
            // Show loading indicator
            const adviceContent = document.querySelector('.advice-content');
            const originalContent = adviceContent.innerHTML;
            adviceContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Finding nearby ${getSpecialtyName(specialty)} specialists...</p>
                    <small class="text-muted">We need your location to find the nearest doctors</small>
                </div>
            `;

            // Get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        showNearbyDoctors(specialty, lat, lng, adviceContent, originalContent);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        adviceContent.innerHTML = originalContent;
                        
                        let errorMessage = "Could not get your location. Please enable location services.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Location access was denied. Please enable location permissions in your browser settings.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Location request timed out. Please try again.";
                        }
                        
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-danger';
                        errorAlert.innerHTML = `
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${errorMessage}
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="findNearbyDoctors('${specialty}')">
                                Try Again
                            </button>
                        `;
                        adviceContent.innerHTML = originalContent;
                        adviceContent.prepend(errorAlert);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                adviceContent.innerHTML = originalContent;
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger';
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Geolocation is not supported by your browser.
                `;
                adviceContent.prepend(errorAlert);
            }
        }

        // Function to get specialty name
        function getSpecialtyName(specialty) {
            const specialties = {
                diabetes: "Endocrinologist",
                heart: "Cardiologist",
                kidney: "Nephrologist"
            };
            return specialties[specialty] || "Doctor";
        }

        // Function to show nearby doctors (simulated for demo)
        function showNearbyDoctors(specialty, lat, lng, container, originalContent) {
            const specialtyName = getSpecialtyName(specialty);
            const distance1 = (Math.random() * 5 + 0.5).toFixed(1);
            const distance2 = (parseFloat(distance1) + 0.8).toFixed(1);
            
            // Simulated results
            const resultsHTML = `
                <div class="animate__animated animate__fadeIn">
                    <h4>Nearby ${specialtyName}s</h4>
                    <p class="text-muted mb-3">
                        <i class="fas fa-map-pin text-danger"></i> 
                        Showing results near your location (${lat.toFixed(4)}, ${lng.toFixed(4)})
                    </p>
                    
                    <div class="card doctor-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">City General Hospital</h5>
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-star"></i> 4.8
                                        </span>
                                        <span class="text-muted">(124 reviews)</span>
                                    </div>
                                </div>
                                <span class="doctor-distance">${distance1} mi</span>
                            </div>
                            
                            <p class="card-text">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i> 
                                123 Medical Center Drive<br>
                                <i class="fas fa-phone text-muted me-2"></i> (555) 123-4567<br>
                                <i class="fas fa-clock text-muted me-2"></i> Open until 7:00 PM
                            </p>
                            
                            <div class="d-flex gap-2">
                                <a href="https://www.google.com/maps?q=${specialtyName}+City+General+Hospital" 
                                   target="_blank" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-directions"></i> Directions
                                </a>
                                <a href="tel:+15551234567" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-phone"></i> Call
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card doctor-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${specialtyName} Specialty Center</h5>
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-star"></i> 4.5
                                        </span>
                                        <span class="text-muted">(87 reviews)</span>
                                    </div>
                                </div>
                                <span class="doctor-distance">${distance2} mi</span>
                            </div>
                            
                            <p class="card-text">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i> 
                                456 Health Parkway<br>
                                <i class="fas fa-phone text-muted me-2"></i> (555) 987-6543<br>
                                <i class="fas fa-clock text-muted me-2"></i> Open until 5:30 PM
                            </p>
                            
                            <div class="d-flex gap-2">
                                <a href="https://www.google.com/maps?q=${specialtyName}+Specialty+Center" 
                                   target="_blank" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-directions"></i> Directions
                                </a>
                                <a href="tel:+15559876543" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-phone"></i> Call
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <a href="https://www.google.com/maps/search/${specialtyName}+near+me/@${lat},${lng},15z" 
                           target="_blank" 
                           class="btn btn-success">
                            <i class="fas fa-search"></i> View More on Google Maps
                        </a>
                        <button class="btn btn-secondary" onclick="container.innerHTML = originalContent">
                            <i class="fas fa-arrow-left"></i> Back to Advice
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = resultsHTML;
        }

        // Show advice modal if prediction was made
        document.addEventListener('DOMContentLoaded', function() {
            {% if show_result and health_advice %}
            document.getElementById('adviceModal').style.display = 'flex';
            {% endif %}
            
            // Auto-open chatbot on first visit (optional)
            const firstVisit = !localStorage.getItem('chatbotFirstVisit');
            if (firstVisit) {
                localStorage.setItem('chatbotFirstVisit', 'true');
                // Uncomment to auto-open on first visit
                // setTimeout(() => toggleChatbot(), 2000);
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>